---
import { PUBLIC_BASE_URL } from 'astro:env/client';
import Layout from '../layouts/Layout.astro';
import "../styles/eurl.css";
import ColorInput from '../components/ColorInput.astro';
import TplInput from '../components/TplInput.astro';
import { fontFileMap } from '../../core/loaders/loadFonts';
import { pathMap } from '../../core/loaders/assets';
---
<Layout>
<section id="intro" class="prose prose-sm !max-w-none -mt-[1em] border-b-1 mb-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="col-span-2">
            <!-- <h2>簡介</h2> -->
            <p class="xl:inline">本站提供URL直連網址，可讓你在設計網站時，在已知尺寸的情況下，可快速插入預留圖可以幫助您排版。同時也新增邊緣背景設計的功能，方便用於製作螢幕截圖示意圖、簡報圖美化用途。</p>
            <p class="xl:inline xl:pl-[1em]">更詳盡的說明，請看 ➤ <a href="/use">使用說明</a></p>
            <h3>常用範例</h3>
            <pre class="overflow-x-auto">&lt;img src=&quot;{PUBLIC_BASE_URL}/300x200.svg&quot;&gt; &lt;!-- &#x4E00;&#x822C;&#x9810;&#x7559;&#x5716; --&gt;
&lt;img src=&quot;{PUBLIC_BASE_URL}/400x200?text=&#x1F5BC;&#xFE0F;&#x9810;&#x7559;&#x5716;&#x1F609;&amp;filetype=png&quot;&gt; &lt;!-- &#x81EA;&#x8A02;&#x6587;&#x6848;&#x9810;&#x7559;&#x5716; --&gt;
&lt;img src=&quot;{PUBLIC_BASE_URL}/400x200/ff0000/FFF/?text=I am red.&quot;&gt; &lt;!-- &#x81EA;&#x8A02;&#x80CC;&#x666F;&#x8272;&#x8207;&#x6587;&#x5B57;&#x984F;&#x8272;&#x7684;&#x9810;&#x7559;&#x5716; --&gt;
&lt;img src=&quot;{PUBLIC_BASE_URL}/300x200/bg/5/10/ph.svg&quot;&gt; &lt;!-- &#x5E36;&#x6709;&#x5E36;&#x6709;&#x9670;&#x5F71;&#x7684;&#x900F;&#x660E;&#x908A;&#x7DE3;&#x7684;&#x9810;&#x7559;&#x5716; --&gt;
&lt;img src=&quot;{PUBLIC_BASE_URL}/300x200/bg/5/10/4/tpl(drool)/ph.svg&quot;&gt; &lt;!--&#x5E36;&#x6709;&#x5E36;&#x6709;&#x5713;&#x89D2;&#x9670;&#x5F71;&#x7684;&#x5716;&#x6848;&#x908A;&#x7DE3;&#x7684;&#x9810;&#x7559;&#x5716;--&gt;</pre>
        </div>
        <div class="prose-img:m-2 hidden lg:flex">
            <img class="" alt="fakeimg.pl" src="/440x250/bg/5/3/ph/282828/eae0d0">
        </div>
    </div>
</section>

<article class="grid">
    <header class="prose">
        <h2 class="">製作佔位圖</h2>
    </header>

    <!-- eurl section -->
    <div class="sticky top-0 eurl my-6 p-2 rounded-xl w-full whitespace-nowrap bg-neutral text-neutral-content z-20 shadow-lg">
      <span class="eurl-base"><span class="eurl-group">{PUBLIC_BASE_URL}</span></span>
      <span class="eurl-content" id="eurl-content">
          <!-- Dynamic content will be injected here by JS -->
      </span>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
        <div class="lg:col-span-5">

            <form id="generator-form" action="/generate" method="GET">
            <div class="grid gap-4">
                    <!-- Canvas Size Section -->
                    <section class="card bg-indigo-600/30 shadow-sm">
                        <div class="card-body">
                            <header class="md:flex items-center justify-between">
                                <h2 class="card-title md:flex mb-0">畫布大小</h2>
                                <div>
                                    <p class="label">Optional</p>
                                    <input type="checkbox" id="toggle-canvas-size" class="toggle" />
                                </div>
                            </header>

                            <div class="content" id="content-canvas-size">
                                <fieldset class="fieldset">
                                    <label class="input w-full">
                                        <input type="number" name="canvas_width" placeholder="Width" class="w-full" /><span class="label">px</span>
                                        x
                                        <input type="number" name="canvas_height" placeholder="Height" class="w-full" /><span class="label">px</span>
                                    </label>
                                </fieldset>
                            </div>
                        </div>
                    </section>

                    <!-- Edge Background Section -->
                    <section class="card bg-cyan-600/30 shadow-sm">
                        <div class="card-body">
                            <header class="md:flex items-center justify-between">
                                <h2 class="card-title md:flex mb-0">邊緣背景</h2>
                                <div>
                                    <p class="label">Optional</p>
                                    <input type="checkbox" id="toggle-edge-bg" class="toggle" />
                                </div>
                            </header>

                            <div class="content" id="content-edge-bg">
                                <fieldset class="fieldset">
                                    <legend class="fieldset-legend">Padding</legend>
                                    <label class="input w-full">
                                        <input type="number" name="bg_padding_w" placeholder="Width" class="w-full" /><span class="label">%</span>
                                        x
                                        <input type="number" name="bg_padding_h" placeholder="Height" class="w-full" /><span class="label">%</span>
                                    </label>
                                </fieldset>

                                <fieldset class="fieldset">
                                    <legend class="fieldset-legend">Shadow</legend>
                                    <input type="number" name="bg_shadow" class="input w-full" placeholder="0" />
                                    <p class="label">Optional</p>
                                </fieldset>

                                <fieldset class="fieldset">
                                    <legend class="fieldset-legend">Radius</legend>
                                    <input type="number" name="bg_radius" class="input w-full" placeholder="0" />
                                    <p class="label">Optional</p>
                                </fieldset>

                                <fieldset class="fieldset">
                                    <div class="tabs">
                                        <legend class="fieldset-legend mr-6">Background</legend>
                                        <label class="label pr-4">
                                            <input type="radio" name="bg_type" class="tab radio" value="color" checked />
                                            Color
                                        </label>
                                        <div class="tab-content">
                                            <ColorInput name="bg_color" />
                                        </div>

                                        <label class="label pr-4">
                                            <input type="radio" name="bg_type" class="tab radio" value="tpl" />
                                            Template
                                        </label>
                                        <div class="tab-content">
                                            <TplInput name="bg_tpl" options={pathMap} />
                                        </div>

                                        <label class="label">
                                            <input type="radio" name="bg_type" class="tab radio" value="none" />None
                                        </label>
                                        <div class="tab-content">
                                            <div class="p-2 text-sm opacity-50">Transarent Background</div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                    </section>

                    <!-- Main Content Section -->
                    <section class="card bg-yellow-600/30 shadow-sm">
                        <div class="p-3">

                            <div class="tabs tabs-lift">
                                <header class="items-center justify-between mr-4 ml-2 mt-2">
                                    <h2 class="card-title mb-0">主內容</h2>
                                </header>

                                <label class="tab">
                                    <input type="radio" name="content_tab" checked />
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 me-2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" /></svg>
                                    placeholder
                                </label>
                                <div class="tab-content bg-base-100/50 border-base-300 p-3">
                                    <fieldset class="fieldset" id="block-size-fieldset">
                                        <legend class="fieldset-legend">區塊大小 (Block Size)</legend>
                                        <label class="input w-full">
                                            <input type="number" name="ph_width" placeholder="Width" class="w-full" /><span class="label">px</span>
                                            x
                                            <input type="number" name="ph_height" placeholder="Height" class="w-full" /><span class="label">px</span>
                                        </label>
                                    </fieldset>

                                    <fieldset class="fieldset">
                                        <div class="tabs">
                                            <legend class="fieldset-legend mr-6">Background</legend>
                                            <label class="label pr-4">
                                                <input type="radio" name="ph_bg_type" class="tab radio" value="color" checked />
                                                Color
                                            </label>
                                            <div class="tab-content">
                                                <ColorInput name="ph_bg_color" />
                                            </div>

                                            <label class="label pr-4">
                                                <input type="radio" name="ph_bg_type" class="tab radio" value="tpl" />
                                                Template
                                            </label>
                                            <div class="tab-content">
                                                <TplInput name="ph_bg_tpl" options={pathMap} />
                                            </div>

                                            <label class="label">
                                                <input type="radio" name="ph_bg_type" class="tab radio" value="default" />Default
                                            </label>
                                            <div class="tab-content">
                                                <div class="p-2 text-sm opacity-50">Default Color</div>
                                            </div>
                                        </div>
                                    </fieldset>

                                    <fieldset class="fieldset">
                                        <div class="tabs">
                                            <legend class="fieldset-legend mr-6">Foreground Color</legend>
                                            <label class="label pr-4">
                                                <input type="radio" name="ph_fg_type" class="tab radio" value="color" checked />
                                                Color
                                            </label>
                                            <div class="tab-content">
                                                <ColorInput name="ph_fg_color" />
                                            </div>

                                            <label class="label">
                                                <input type="radio" name="ph_fg_type" class="tab radio" value="default" />Default
                                            </label>
                                            <div class="tab-content">
                                                <div class="p-2 text-sm opacity-50">Default Color</div>
                                            </div>
                                        </div>
                                    </fieldset>

                                    <fieldset class="fieldset">
                                        <legend class="fieldset-legend">Text</legend>
                                        <input type="text" name="text" class="input w-full" placeholder="" />
                                        <p class="label">Optional</p>
                                    </fieldset>

                                    <fieldset class="fieldset">
                                        <legend class="fieldset-legend">Font</legend>
                                        <select name="font" class="select w-full">
                                            <option value="">預設 (Default)</option>
                                            {Object.entries(fontFileMap).map(([key, value]) => (
                                                <option value={key}>{key}</option>
                                            ))}
                                        </select>
                                    <span class="label">Optional</span>
                                    </fieldset>

                                </div>
                            </div>

                        </div>
                    </section>


                    <section class="card bg-green-600/30 shadow-sm">
                        <div class="card-body">
                            <header class="md:flex items-center justify-between">
                                <h2 class="card-title md:flex mb-0">額外設定</h2>
                            </header>

                            <fieldset class="fieldset">
                                <legend class="fieldset-legend">Scale</legend>
                                <label class="input px-0">
                                    <select name="scale" class="select rounded-r-none">
                                        <option value="1" selected>1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                    <span class="label m-0 -ml-2.5">px</span>
                                </label>
                            </fieldset>

                            <fieldset class="fieldset">
                                <legend class="fieldset-legend">Login options</legend>
                                <label class="label">
                                    <input type="checkbox" name="debug" value="1" class="checkbox" />
                                    Debug Mode
                                </label>
                            </fieldset>

                            <fieldset class="fieldset">
                                <legend class="fieldset-legend">輸出格式</legend>
                                <div class="join">
                                    <input class="join-item btn" type="radio" name="filetype" value="null" aria-label="預設" checked />
                                    <input class="join-item btn" type="radio" name="filetype" value="svg" aria-label=".svg" />
                                    <input class="join-item btn" type="radio" name="filetype" value="png" aria-label=".png" />
                                    <input class="join-item btn" type="radio" name="filetype" value="ico" aria-label=".ico" />
                                </div>
                            </fieldset>

                            <noscript>
                                <button type="submit" class="btn btn-primary w-full mt-4">Generate URL (No JS)</button>
                            </noscript>

                        </div>
                    </section>
                </div>
            </form>
        </div>

        <div class="lg:col-span-7">
            <div class="sticky top-24 grid gap-4 z-10">

                <section class="mockup-browser border-base-300 border w-full">
                    <div class="mockup-browser-toolbar">
                        <span id="preview-loading" class="loading loading-spinner loading-md hidden"></span>
                        <div class="input w-[65%] p-2 overflow-hidden text-ellipsis whitespace-nowrap" id="preview-url-display">...</div>
                        <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn m-0">下載▼</div>
                        <ul tabindex="-1" class="dropdown-content menu bg-base-100 rounded-box z-1 w-52 p-2 shadow-sm">
                            <li><a id="download-svg" target="_blank" download>.svg</a></li>
                            <li><a id="download-png" target="_blank" download>.png</a></li>
                            <li><a id="download-ico" target="_blank" download>.ico</a></li>
                        </ul>
                        </div>
                    </div>
                    <div class="grid place-content-center p-4 border-t border-base-300 backgroundImg-grid min-h-[300px]">
                        <img id="preview-image" src="" alt="Preview" class="max-w-full h-auto" />
                    </div>
                </section>

                <section class="card bg-base-200 shadow-sm">
                    <div class="card-body">
                        <header class="md:flex items-center justify-between">
                            <h2 class="card-title md:flex mb-0">嵌入圖片</h2>
                        </header>
                        <!-- name of each tab group should be unique -->
                        <div class="tabs tabs-lift">
                        <input type="radio" name="embed" class="tab" aria-label="HTML" checked />
                        <div class="tab-content break-all border-base-300 bg-base-100 p-6">
                            <pre class="text-wrap break-all" id="embed-html"></pre>
                        </div>

                        <input type="radio" name="embed" class="tab" aria-label="Markdown" />
                        <div class="tab-content break-all border-base-300 bg-base-100 p-6">
                            <pre class="text-wrap break-all" id="embed-markdown"></pre>
                        </div>
                        </div>
                    </div>
                </section>

            </div>
        </div>
    </div>

</article>
</Layout>

<script>
    import { PUBLIC_BASE_URL } from 'astro:env/client';

    // Configuration & Defaults
    const CONFIG = {
        debounceDelay: 1000,
        defaults: {
            alpha: '255',
            scale: '1',
            shadow: '',
            radius: '',
            padding: '',
            canvasWidth: '',
            canvasHeight: '',
            blockWidth: '300',
            blockHeight: '',
            embedAlt: 'Image'
        }
    };

    // Helper to get element by ID with type safety
    function getEl<T extends HTMLElement>(id: string): T | null {
        return document.getElementById(id) as T | null;
    }

    function getInputs(containerId: string): NodeListOf<HTMLInputElement | HTMLSelectElement> {
        const container = getEl(containerId);
        return container ? container.querySelectorAll('input, select') : document.querySelectorAll('should-not-match');
    }

    const sections = {
        canvasSize: {
            toggle: getEl<HTMLInputElement>('toggle-canvas-size'),
            content: getEl<HTMLElement>('content-canvas-size'),
            inputs: getInputs('content-canvas-size')
        },
        edgeBg: {
            toggle: getEl<HTMLInputElement>('toggle-edge-bg'),
            content: getEl<HTMLElement>('content-edge-bg'),
            inputs: getInputs('content-edge-bg')
        },
        blockSize: {
            fieldset: getEl<HTMLFieldSetElement>('block-size-fieldset'),
            inputs: getEl<HTMLFieldSetElement>('block-size-fieldset')?.querySelectorAll('input')
        }
    };

    const form = getEl<HTMLFormElement>('generator-form');
    const previewImage = getEl<HTMLImageElement>('preview-image');
    const previewLoading = getEl<HTMLElement>('preview-loading');
    const previewUrlDisplay = getEl<HTMLElement>('preview-url-display');
    const eurlContent = getEl<HTMLElement>('eurl-content');
    const embedHtml = getEl<HTMLElement>('embed-html');
    const embedMarkdown = getEl<HTMLElement>('embed-markdown');
    const downloadLinks = {
        svg: getEl<HTMLAnchorElement>('download-svg'),
        png: getEl<HTMLAnchorElement>('download-png'),
        ico: getEl<HTMLAnchorElement>('download-ico')
    };

    function updateUIState() {
        // Toggle Canvas Size visibility
        if (sections.canvasSize.toggle && sections.canvasSize.content) {
            const isCanvasSizeEnabled = sections.canvasSize.toggle.checked;
            sections.canvasSize.content.style.display = isCanvasSizeEnabled ? 'block' : 'none';

            // Check if Canvas Size inputs (or defaults) have values
            let hasCanvasValues = false;
            if (isCanvasSizeEnabled) {
                const w = (form?.elements.namedItem('canvas_width') as HTMLInputElement)?.value || CONFIG.defaults.canvasWidth;
                const h = (form?.elements.namedItem('canvas_height') as HTMLInputElement)?.value || CONFIG.defaults.canvasHeight;
                if (w || h) hasCanvasValues = true;
            }

            // Disable/Enable Block Size based on Canvas Size usage
            if (sections.blockSize.fieldset && sections.blockSize.inputs) {
                // If Canvas Size is enabled AND has values, we disable Block Size
                // If Canvas Size is disabled OR empty, we enable Block Size
                const shouldDisableBlockSize = isCanvasSizeEnabled && hasCanvasValues;
                sections.blockSize.fieldset.disabled = shouldDisableBlockSize;
                sections.blockSize.fieldset.style.opacity = shouldDisableBlockSize ? '0.5' : '1';

                if (!shouldDisableBlockSize && sections.blockSize.fieldset.disabled) {
                     sections.blockSize.fieldset.disabled = false;
                }
            }
        }

        // Toggle Edge Bg visibility
        if (sections.edgeBg.toggle && sections.edgeBg.content) {
            const isEdgeBgEnabled = sections.edgeBg.toggle.checked;
            sections.edgeBg.content.style.display = isEdgeBgEnabled ? 'block' : 'none';
        }
    }

    function generateURL() {
        if (!form) return;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        let urlParts: string[] = [];

        // Helper methods
        const getColor = (prefix: string) => {
            const hex = (data[`${prefix}_hex`] as string)?.trim();
            const alpha = data[`${prefix}_alpha`] as string;
            if (!hex) return '';
            if (alpha && alpha !== CONFIG.defaults.alpha) return `${hex},${alpha}`;
            return hex;
        };

        const processSegments = (items: {value: string, title: string}[]) => {
            // 1. Trim trailing empty values
            let end = items.length - 1;
            while (end >= 0 && !items[end].value) {
                end--;
            }
            if (end < 0) return []; // All empty

            // 2. Map up to end, replacing empty with 'null'
            const result = [];
            for (let i = 0; i <= end; i++) {
                const item = items[i];
                if (item.value) {
                    result.push(item);
                } else {
                    result.push({ value: 'null', title: item.title });
                }
            }
            return result;
        };

        // 1. Canvas Size
        let canvasHtml = '';
        const isCanvasSizeEnabled = sections.canvasSize.toggle?.checked;
        const canvasW = ((data.canvas_width as string) || CONFIG.defaults.canvasWidth)?.trim();
        const canvasH = ((data.canvas_height as string) || CONFIG.defaults.canvasHeight)?.trim();
        const hasCanvasValues = canvasW || canvasH;

        if (isCanvasSizeEnabled && hasCanvasValues) {
            let val = '';
            if (canvasW && canvasH) {
                 val = `${canvasW}x${canvasH}`;
            } else if (canvasW) {
                 val = canvasW;
            } else if (canvasH) {
                 val = canvasH;
            }

            if (val) {
                 urlParts.push(val);
                 canvasHtml = `<span class="eurl-group hover:bg-indigo-600/30 inline">/<span class="eurl-part" data-url-ptitle="Canvas Size">${val}</span></span>`;
            }
        }

        // 2. Edge Background
        let edgeBgHtml = '';
        const isEdgeBgEnabled = sections.edgeBg.toggle?.checked;
        if (isEdgeBgEnabled) {
             const pw = ((data.bg_padding_w as string) || CONFIG.defaults.padding)?.trim();
             const ph = ((data.bg_padding_h as string) || '')?.trim();
             let padding = '';

             if (pw && ph) {
                 padding = (pw === ph) ? pw : `${pw}x${ph}`;
             } else if (pw) {
                 padding = pw;
             } else if (ph) {
                 padding = `0x${ph}`;
             }
             // NOTE: Removed forced default '15' for padding to allow omission

             const shadow = (data.bg_shadow === CONFIG.defaults.shadow || data.bg_shadow === '') ? '' : data.bg_shadow as string;
             const radius = (data.bg_radius === CONFIG.defaults.radius || data.bg_radius === '') ? '' : data.bg_radius as string;

             let color = '';
             if (data.bg_type === 'color') color = getColor('bg_color');
             else if (data.bg_type === 'tpl' && data.bg_tpl) color = `tpl(${data.bg_tpl})`;

             // Segments: Padding, Shadow, Radius, Color
             const segments = [
                 { value: padding, title: 'Padding' },
                 { value: shadow, title: 'Shadow' },
                 { value: radius, title: 'Radius' },
                 { value: color, title: 'Color' }
             ];

             const processed = processSegments(segments);

             if (processed.length > 0) {
                 urlParts.push('bg');
                 processed.forEach(p => urlParts.push(p.value));

                 // Display HTML
                 edgeBgHtml = `<span class="eurl-group hover:bg-cyan-600/30">/bg`;
                 processed.forEach(p => {
                     // Check if value includes standard default, maybe warn or something? No, user wants clean URL.
                     edgeBgHtml += `/<span class="eurl-part" data-url-ptitle="${p.title}">${p.value}</span>`;
                 });
                 edgeBgHtml += `</span>`;
             }
        }

        // 3. Main Content (Placeholder)
        let phHtml = '';
        const phSegments: {value: string, title: string}[] = [];

        // Size
        // If (isCanvasSizeEnabled && hasCanvasValues) -> Block Size disabled.
        // We use Block Size values if: Canvas Size is NOT enabling full block override.
        if (!(isCanvasSizeEnabled && hasCanvasValues)) {
            const w = ((data.ph_width as string) || CONFIG.defaults.blockWidth)?.trim();
            const h = ((data.ph_height as string) || CONFIG.defaults.blockHeight)?.trim();
            let val = '';

            if (w && h) val = `${w}x${h}`;
            else if (w) val = w;
            else if (h) val = h;

            phSegments.push({ value: val, title: 'Block Size' });
        }

        // BG
        let phBg = '';
        if (data.ph_bg_type === 'color') phBg = getColor('ph_bg_color');
        else if (data.ph_bg_type === 'tpl' && data.ph_bg_tpl) phBg = `tpl(${data.ph_bg_tpl})`;
        // If default/empty, phBg is ''.

        phSegments.push({ value: phBg, title: 'bgcolor' });

        // FG
        let phFg = '';
        if (data.ph_fg_type === 'color') phFg = getColor('ph_fg_color');

        phSegments.push({ value: phFg, title: 'fgcolor' });

        const processedPh = processSegments(phSegments);

        urlParts.push('ph'); // Always present? Yes, core feature.
        processedPh.forEach(p => urlParts.push(p.value));

        phHtml = `<span class="eurl-group hover:bg-yellow-600/30">/ph`;
        processedPh.forEach(p => {
            phHtml += `/<span class="eurl-part" data-url-ptitle="${p.title}">${p.value}</span>`;
        });

        // Query Params
        const params = new URLSearchParams();
        if (data.text) params.append('text', data.text as string);
        if (data.font) params.append('font', data.font as string);
        if (data.scale && data.scale !== CONFIG.defaults.scale) params.append('scale', data.scale as string);
        if (data.debug) params.append('debug', '1');

        let filetype = data.filetype as string;
        if (filetype && filetype !== 'null') {
             params.append('filetype', filetype);
        }

        const queryString = params.toString();
        if (queryString) {
            phHtml += `/?<span class="eurl-part">${queryString.replace(/&/g, '&<wbr>')}</span>`;
        }
        phHtml += `</span>`;


        const fullPath = "/" + urlParts.join("/") + (queryString ? `/?${queryString}` : "");
        const fullUrl = `${PUBLIC_BASE_URL}${fullPath}`;

        // Update EURL Display
        if (eurlContent) {
           let html = '';
           html += canvasHtml;
           html += edgeBgHtml;
           html += phHtml;
           eurlContent.innerHTML = html;
        }

        // Update Preview (Force SVG)
        const previewParams = new URLSearchParams(params);
        previewParams.set('filetype', 'svg');
        const previewUrl = `/${urlParts.join("/")}/?${previewParams.toString()}`;

        if (previewImage) {
            if (previewImage.src !== previewUrl) {
                previewLoading?.classList.remove('hidden');
                previewImage.src = previewUrl;
            }
        }
        if (previewUrlDisplay) previewUrlDisplay.textContent = fullUrl;

        // Update Embeds
        if (embedHtml) embedHtml.innerText = `<img src="${fullUrl}">`;
        if (embedMarkdown) embedMarkdown.innerText = `![${data.text || CONFIG.defaults.embedAlt}](${fullUrl})`;

        // Update Downloads
        if (downloadLinks.svg) downloadLinks.svg.href = fullPath.replace(/filetype=[^&]+/, 'filetype=svg').replace(/\?$/, '') + (fullPath.includes('?') ? '&' : '?') + 'filetype=svg';
        if (downloadLinks.png) downloadLinks.png.href = fullPath.replace(/filetype=[^&]+/, 'filetype=png').replace(/\?$/, '') + (fullPath.includes('?') ? '&' : '?') + 'filetype=png';
        if (downloadLinks.ico) downloadLinks.ico.href = fullPath.replace(/filetype=[^&]+/, 'filetype=ico').replace(/\?$/, '') + (fullPath.includes('?') ? '&' : '?') + 'filetype=ico';
    }

    // Hide loader when image stays loaded or errors
    if (previewImage) {
        previewImage.addEventListener('load', () => {
            previewLoading?.classList.add('hidden');
        });
        previewImage.addEventListener('error', () => {
            previewLoading?.classList.add('hidden');
        });
    }

    // Event Listeners
    let debounceTimer: ReturnType<typeof setTimeout> | null = null;

    function runPending() {
       if (debounceTimer) {
           clearTimeout(debounceTimer);
           debounceTimer = null;
       }
       generateURL();
    }

    function scheduleRun() {
       if (debounceTimer) clearTimeout(debounceTimer);
       debounceTimer = setTimeout(() => {
           generateURL();
           debounceTimer = null;
       }, CONFIG.debounceDelay);
    }

    if (form) {
        const showLoader = () => previewLoading?.classList.remove('hidden');
        form.addEventListener('change', () => {
            showLoader();
            runPending();
        });
        form.addEventListener('input', () => {
            showLoader();
            scheduleRun();
            updateUIState();
        });
    }

    if (sections.canvasSize.toggle) {
        sections.canvasSize.toggle.addEventListener('change', () => {
            updateUIState();
            runPending();
        });
    }

    if (sections.edgeBg.toggle) {
        sections.edgeBg.toggle.addEventListener('change', () => {
            updateUIState();
            runPending();
        });
    }

    function applyDefaultsToForm() {
        if (!form) return;
        const mapping: Record<string, string> = {
            'canvas_width': CONFIG.defaults.canvasWidth,
            'canvas_height': CONFIG.defaults.canvasHeight,
            'ph_width': CONFIG.defaults.blockWidth,
            'ph_height': CONFIG.defaults.blockHeight,
            'bg_padding_w': CONFIG.defaults.padding,
            'bg_shadow': CONFIG.defaults.shadow,
            'bg_radius': CONFIG.defaults.radius,
            'scale': CONFIG.defaults.scale,
            'bg_color_alpha': CONFIG.defaults.alpha,
            'ph_bg_color_alpha': CONFIG.defaults.alpha,
            'ph_fg_color_alpha': CONFIG.defaults.alpha
        };

        for (const [name, val] of Object.entries(mapping)) {
            const input = form.elements.namedItem(name) as HTMLInputElement | HTMLSelectElement;
            if (input && val !== undefined && val !== '') {
                input.value = val;
            }
        }
    }

    // Initialize
    applyDefaultsToForm();
    updateUIState();
    generateURL();

</script>
