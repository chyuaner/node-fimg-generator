---
interface Option {
  label: string;
  value: string;
  image?: string;
  fontId?: string;
  fontExText?: string;
  description?: string;
}

interface Props {
  name: string;
  id?: string;
  options: Option[];
  defaultValue?: string;
  placeholder?: string;
  class?: string;
  disabled?: boolean;
}

const {
  name,
  id = `dropdown-${name}`,
  options,
  defaultValue = '',
  placeholder = 'Select option...',
  class: className = '',
  disabled = false,
} = Astro.props;

// Find the initial label
const selectedOption = options.find(o => o.value === defaultValue);
const displayLabel = selectedOption ? selectedOption.label : placeholder;
---

<dropdown-select class={`block dropdown dropdown-bottom w-full dropdown-select ${className} group`} id={id} data-name={name} data-placeholder={placeholder}>
  <!-- Native Select: Visible by default, hidden when JS is active -->
  <select
    name={name}
    class="select select-bordered w-full native-select group-[.is-js]:hidden"
    {disabled}
  >
    {options.map(opt => (
      <option value={opt.value} selected={opt.value === defaultValue}>
        {opt.label}
      </option>
    ))}
  </select>

  <!-- Custom UI: Hidden by default, shown when JS is active -->
  <div class="custom-ui hidden group-[.is-js]:block">
    <div
      tabindex={disabled ? -1 : 0}
      role="button"
      class={`select select-bordered flex items-center justify-between w-full h-auto py-2 min-h-[38px] ${disabled ? 'select-disabled pointer-events-none opacity-50' : ''}`}
    >
      <div class="flex items-center gap-3 overflow-hidden">
        <img src="" alt="" class="selected-img w-8 h-8 object-cover rounded bg-base-200 shrink-0 hidden" />
        <span class="selected-label truncate">{displayLabel}</span>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-50 shrink-0 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </div>
    {!disabled && (
      <div
        class={`
          dropdown-content bg-base-100 rounded-box z-[100] p-2 shadow-xl border border-base-300 mt-1
           max-h-140 sm:max-h-80 lg:max-h-125 xl:max-h-80 w-full overflow-auto
        `}>
      <ul
        tabindex="0"
        class={`menu max-h-none sm:max-h-80 lg:max-h-none xl:max-h-80 w-full`}
      >
        {options.map(opt => (
          <li>
            <button type="button" class="menu-item flex items-center gap-3 text-left w-full focus:bg-primary focus:text-primary-content" data-value={opt.value} data-label={opt.label}>
              {opt.image && <img src={opt.image} alt="" class="w-10 h-10 object-cover rounded bg-base-200 shrink-0 option-img" />}
              <div class="flex flex-col">
                <div class="flex-none flex flex-col overflow-hidden">
                  <span class="font-medium truncate">{opt.label}</span>
                  {opt.description && <span class="text-xs opacity-60 truncate">{opt.description}</span>}
                </div>
                {(opt.fontId || opt.fontExText) &&
                  <span class="truncate">
                    <img
                      class="scale-230 max-w-64"
                      src={`/500x100/FFF,0/?${opt.fontId ? `font=${encodeURIComponent(opt.fontId)}&` : ''}text=${encodeURIComponent(opt.fontExText ?? "Eng繁中カタカナ한국어")}`}
                      alt={opt.fontId}
                      fetchpriority="low"
                      />
                  </span>
                }
              </div>
            </button>
          </li>
        ))}
      </ul>
      </div>
    )}
  </div>
</dropdown-select>

<script>
  class DropdownSelect extends HTMLElement {
    connectedCallback() {
      // Enable Custom UI by adding class
      this.classList.add('is-js');

      const nativeSelect = this.querySelector('.native-select') as HTMLSelectElement;
      const label = this.querySelector('.selected-label') as HTMLElement;
      const selectedImg = this.querySelector('.selected-img') as HTMLImageElement;
      const buttons = this.querySelectorAll('ul button') as NodeListOf<HTMLButtonElement>;

      const updateUI = (val: string) => {
        const match = Array.from(buttons).find(b => b.dataset.value === val);
        buttons.forEach(b => b.classList.remove('menu-active'));
        if (match) {
          match.classList.add('menu-active');
          if (label) label.textContent = match.dataset.label || '';

          const optionImg = match.querySelector('.option-img') as HTMLImageElement;
          if (selectedImg) {
            if (optionImg && optionImg.src) {
              selectedImg.src = optionImg.src;
              selectedImg.classList.remove('hidden');
            } else {
              selectedImg.classList.add('hidden');
              selectedImg.src = '';
            }
          }
        } else if (!val && label) {
           label.textContent = this.getAttribute('data-placeholder') || 'Select option...';
           if (selectedImg) selectedImg.classList.add('hidden');
        }
      };

      buttons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const val = btn.dataset.value || '';

          if (nativeSelect.value !== val) {
            nativeSelect.value = val;
            updateUI(val);
            // Dispatch events on the REAL select so form listeners react
            nativeSelect.dispatchEvent(new Event('input', { bubbles: true }));
            nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
          }

          // Close dropdown
          if (document.activeElement instanceof HTMLElement) {
            document.activeElement.blur();
          }
        });
      });

      // Handle programmatic changes to the native select
      nativeSelect.addEventListener('change', () => {
         updateUI(nativeSelect.value);
      });

      // Initial sync (in case it was pre-filled)
      updateUI(nativeSelect.value);
    }
  }

  if (!customElements.get('dropdown-select')) {
    customElements.define('dropdown-select', DropdownSelect);
  }
</script>

<style>
  .dropdown-select .select {
    padding-left: 1rem;
    padding-right: 1rem;
    background-image: none;
  }
</style>
