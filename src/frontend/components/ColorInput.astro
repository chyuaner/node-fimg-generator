---
interface Props {
    name?: string;
    disabled?: boolean;
    valHex?: string;
    valAlpha?: string;
}

const { name = 'color', disabled = false, valHex = '', valAlpha = '255' } = Astro.props;
---

<div class="color-input-group flex flex-col gap-1" data-name={name}>
    <div class="flex items-center gap-2">
        <!-- 顏色選擇器 -->
        <div
            class="relative w-10 h-10 rounded-lg overflow-hidden border border-slate-200 shadow-sm shrink-0"
            class:opacity-50={disabled}
        >
            <input
                type="color"
                class="absolute -inset-2 w-14 h-14 cursor-pointer color-picker"
                {disabled}
            />
        </div>

        <!-- Hex 輸入與 Alpha 滑桿 -->
        <div class="flex-1 flex flex-col gap-1">
            <input
                type="text"
                name={`${name}_hex`}
                value={valHex}
                placeholder="Hex (e.g. ff0000)"
                class="input w-full text-sm px-2 py-1 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 hex-input"
                class:opacity-50={disabled}
                {disabled}
            />

            <div class="flex items-center gap-2">
                <input
                    type="range"
                    name={`${name}_alpha`}
                    min="0"
                    max="255"
                    value={valAlpha}
                    class="flex-1 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600 alpha-input"
                    class:cursor-not-allowed={disabled}
                    {disabled}
                />
                <span
                    class="text-[10px] text-slate-400 w-8 text-right font-mono alpha-display"
                    class:text-slate-300={disabled}
                >
                    {Math.round((parseInt(valAlpha) / 255) * 100)}%
                </span>
            </div>
        </div>
    </div>
</div>

<script>
    // Simple client-side sync logic for all color inputs
    document.querySelectorAll('.color-input-group').forEach(group => {
        const picker = group.querySelector('.color-picker') as HTMLInputElement;
        const hexInput = group.querySelector('.hex-input') as HTMLInputElement;
        const alphaInput = group.querySelector('.alpha-input') as HTMLInputElement;
        const alphaDisplay = group.querySelector('.alpha-display') as HTMLElement;

        if (!picker || !hexInput || !alphaInput || !alphaDisplay) return;

        // Sync Picker -> Hex
        picker.addEventListener('input', () => {
            hexInput.value = picker.value.replace('#', '');
             // Trigger change event manually for the parent form listener if needed
            hexInput.dispatchEvent(new Event('input', { bubbles: true }));
        });

        // Sync Hex -> Picker
        hexInput.addEventListener('input', () => {
            let val = hexInput.value;
            if (!val.startsWith('#')) val = '#' + val;
            if (/^#[0-9A-F]{6}$/i.test(val)) {
                picker.value = val;
            }
        });

        // Update Alpha Display
        const updateAlpha = () => {
            const val = parseInt(alphaInput.value || '255');
            alphaDisplay.textContent = `${Math.round((val / 255) * 100)}%`;
        };
        alphaInput.addEventListener('input', updateAlpha);
        updateAlpha(); // Init
    });
</script>
