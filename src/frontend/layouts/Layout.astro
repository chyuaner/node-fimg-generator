---
import "../styles/global.css";

import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import "../styles/eurl.css";

const path = Astro.url.pathname.replace(/\//g, '') || 'index';
import { PUBLIC_BASE_URL } from 'astro:env/client';
const { title, description, keywords } = Astro.props;
---
<script>
import Swup from 'swup';
import SwupHeadPlugin from '@swup/head-plugin';

const swup = new Swup({
    containers: ['#swup'],
    plugins: [new SwupHeadPlugin()]
});

// Import common custom elements to ensure they are always available
import '../scripts/components/dropdown-select';
import '../scripts/components/copy-button';
import '../scripts/components/color-input';

// Handle generator initialization dynamically
async function checkAndInitGenerator() {
    if (document.getElementById('generator-form')) {
        const { initGenerator } = await import('../scripts/generator');
        initGenerator();
    }
}

// Initial run
checkAndInitGenerator();

swup.hooks.on('page:view', () => {
    checkAndInitGenerator();
});

// Height transition for container
// swup.hooks.on('visit:start', () => {
//     const container = document.getElementById('layout-container');
//     if (container) {
//         // Lock the height to current pixel value before content changes
//         container.style.height = `${container.offsetHeight}px`;
//     }
// });

// swup.hooks.before('animation:in:start', async () => {
//     const container = document.getElementById('layout-container');
//     if (!container) return;

//     // We have the new content in DOM (opacity 0), but container height is locked to old height.
//     // 1. Measure new required height (by temporary unlock)
//     const currentHeight = container.style.height;
//     container.style.height = 'auto';
//     const targetHeight = container.offsetHeight;
//     container.style.height = currentHeight;

//     // Force reflow
//     container.offsetHeight;

//     // 2. Animate to new height
//     container.style.transition = 'height 0.5s ease-in-out';
//     container.style.height = `${targetHeight}px`;

//     // 3. Wait for animation to finish
//     await new Promise((resolve) => setTimeout(resolve, 500));

//     // Cleanup
//     container.style.height = 'auto';
//     container.style.transition = '';
// });

// Update Navbar active state
swup.hooks.on('page:view', () => {
    const currentPath = window.location.pathname;
    const siteHeader = document.getElementById('site-header');
    // 若 siteHeader 為 null，回傳空的 NodeList，避免 later 的錯誤
    const tabs = siteHeader
        ? siteHeader.querySelectorAll('nav[role="tablist"] a[role="tab"]')
        : document.createDocumentFragment().querySelectorAll(''); // 空 NodeList

    tabs.forEach(tab => {
        const tabPath = tab.getAttribute('href');
        // Simple match, handling potential trailing slash difference if necessary
        if (
            tabPath === currentPath ||
            (tabPath !== '/' && currentPath === tabPath + '/') ||
            (tabPath === '/' && currentPath.startsWith('/generator/'))
        ) {
            tab.classList.add('tab-active');
        } else {
            tab.classList.remove('tab-active');
        }
    });
});

// Matomo Tracking
var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
    var u="//track.yuaner.tw/";
    _paq.push(['setTrackerUrl', u+'traak.php']);
    _paq.push(['setSiteId', '5']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'traak.js'; s.parentNode.insertBefore(g,s);
})();

swup.hooks.on('content:replace', async (visit) => {
    // Matomo Tracking
    if (window._paq) {
      window._paq.push(['setCustomUrl', window.location.href]);
      window._paq.push(['setDocumentTitle', document.title]);
      window._paq.push(['trackPageView']);
    }
});


</script>

<!doctype html>
<html lang="zh-tw" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <title>Fimg 預留圖產生站{title ? ` - ${title}` : ``}</title>
    <link rel="icon" href="/favicon.png" type="image/png">

    <meta name="description" content={description ?? '提供URL直連網址，可讓你在設計網站時，在已知尺寸的情況下，可快速插入預留圖可以幫助您排版。'} />
    <meta name="keywords" content={keywords ?? 'placeholder, fake image, image generator, URL parameters, SVG, PNG, 色彩, 文字, 佔位圖'} />
    <!-- Open Graph（Facebook、LinkedIn、Plurk 等） -->
    <meta property="og:title" content="Fimg 預留圖產生站" />
    <meta property="og:description" content={description ?? '提供URL直連網址，可讓你在設計網站時，在已知尺寸的情況下，可快速插入預留圖可以幫助您排版。'} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={PUBLIC_BASE_URL} />
    <meta property="og:image" content=`${PUBLIC_BASE_URL}/200/282828/eae0d0/?text=fimg` /> <!-- 替換為實際的 OG 圖片路徑 -->
    <meta property="og:site_name" content="Fimg 預留圖產生站" />
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Fimg 預留圖產生站" />
    <meta name="twitter:description" content={description ?? '提供URL直連網址，可讓你在設計網站時，在已知尺寸的情況下，可快速插入預留圖可以幫助您排版。'} />
    <meta name="twitter:image" content=`${PUBLIC_BASE_URL}/200/282828/eae0d0/?text=fimg` /> <!-- 同上 -->

    <style>
        /* Define a transition duration during page visits */
        html.is-changing .transition-main,
        html.is-animating .transition-main {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        /* 預設顯示狀態（不含任何 Swup class） */
        .transition-main {
            opacity: 1;
            transform: translateY(0);
        }

        /* Swup 正在載入新頁面時 → 隱藏且向下 20px */
        html.is-animating .transition-main {
            opacity: 0;
            transform: translateY(20px);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-base-200">
<div class="grid w-full mx-auto p-4 md:p-8 max-w-400">
<div class="w-full">

    <Navbar />

    <div id="layout-container" class="mx-auto bg-base-100 shadow-lg rounded-xl p-4 md:p-8">
        <!-- <main class="" data-barba="wrapper"> -->
        <main id="swup" class="transition-fade transition-main">
            <div class="grid" data-barba="container" data-barba-namespace={path}>
                    <slot />
            </div>
        </main>
    </div>

    <div class="container mx-auto mt-8">
        <footer>
            <Footer />
        </footer>
    </div>

</div>
</div>
</body>
</html>
